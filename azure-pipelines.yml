trigger:
- main

pool:
  name: LaptopPool

stages:

# ====================
# STAGE 1: BUILD DEPENDENCIES
# ====================
- stage: BuildDependencies
  displayName: Build Dependencies
  jobs:
  - job: Build
    displayName: Install Python Dependencies
    steps:
    - script: |
        source ~/python3.12_venv/bin/activate
        python --version
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: Install required Python packages

# ====================
# STAGE 2: RUN TESTS
# ====================
- stage: RunTests
  displayName: Run Unit Tests
  dependsOn: BuildDependencies
  jobs:
  - job: Test
    displayName: Execute Test Suite
    steps:
    - script: |
        source ~/python3.12_venv/bin/activate
        pip install pytest pytest-azurepipelines
        pytest --cov=. --cov-report=xml
      displayName: Run pytest tests

    - task: PublishCodeCoverageResults@2
      displayName: Publish Test Code Coverage
      inputs:
        codeCoverageTool: Cobertura
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'

# ====================
# STAGE 3: PACKAGE APPLICATION
# ====================
- stage: PackageApplication
  displayName: Package Application
  dependsOn: RunTests
  jobs:
  - job: Package
    displayName: Create Deployment Artifact
    steps:
    - task: ArchiveFiles@2
      displayName: Create ZIP package for deployment
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
        includeRootFolder: false
        archiveType: zip
        archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
        replaceExistingArchive: true

    - publish: '$(Build.ArtifactStagingDirectory)/app.zip'
      displayName: Publish Deployment Artifact
      artifact: drop

# ====================
# STAGE 4: DEPLOY TO AZURE
# ====================
- stage: DeployToAzure
  displayName: Deploy to Azure App Service
  dependsOn: PackageApplication
  jobs:
  - deployment: DeployWebApp
    displayName: Deploy Application
    environment: dev
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            displayName: Download Deployment Artifact
            artifact: drop

          - task: AzureWebApp@1
            displayName: Deploy Application to Azure App Service
            inputs:
              azureSubscription: demo-devops-service-connection
              appName: demo-app
              package: '$(Pipeline.Workspace)/drop/app.zip'

